"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var applicationModule = require("tns-core-modules/application");
var moment = require("moment");
var _ = require("lodash");
var Toast = require("nativescript-toast");
var angular_1 = require("nativescript-ui-dataform/angular");
var platform_1 = require("platform");
var nativescript_barcodescanner_1 = require("nativescript-barcodescanner");
var page_1 = require("ui/page");
var SearchMainComponent = /** @class */ (function () {
    function SearchMainComponent(router, page, barcodeScanner) {
        this.router = router;
        this.page = page;
        this.barcodeScanner = barcodeScanner;
        this.form = {
            arrivalDate: moment().format('YYYY-MM-DD'),
            departureDate: moment().add(1, 'd').format('YYYY-MM-DD'),
            numberOfNights: 1,
            numberOfPAX: 1,
        };
    }
    SearchMainComponent.prototype.ngOnInit = function () {
    };
    SearchMainComponent.prototype.ngAfterViewInit = function () {
    };
    SearchMainComponent.prototype.goSearchTrip = function () {
        if (this.radDataForm.dataForm.hasValidationErrors()) {
            Toast.makeText('Please fix error fields').show();
            return;
        }
        this.router.navigate(['search-result'], {
            queryParams: this.form
        });
    };
    SearchMainComponent.prototype.onPropertyValidate = function (args) {
        var validationResult = true;
        var dataForm = args.object;
        var otherDate, currentDate;
        switch (args.propertyName) {
            case 'arrivalDate':
                otherDate = dataForm.getPropertyByName('departureDate');
                currentDate = args.entityProperty;
                if (this.parseDate(otherDate.valueCandidate) && this.parseDate(otherDate.valueCandidate) < this.parseDate(currentDate.valueCandidate)) {
                    currentDate.errorMessage = 'Arrival date should less than departure date';
                    validationResult = false;
                    dataForm.notifyValidated('arrivalDate', false);
                }
                else {
                    dataForm.notifyValidated('departureDate', true);
                }
                break;
            case 'departureDate':
                otherDate = dataForm.getPropertyByName('arrivalDate');
                currentDate = args.entityProperty;
                if (this.parseDate(otherDate.valueCandidate) > this.parseDate(currentDate.valueCandidate)) {
                    currentDate.errorMessage = 'Departure date should greater than arrival date';
                    validationResult = false;
                }
                else {
                    otherDate.errorMessage = '';
                    dataForm.notifyValidated('arrivalDate', true);
                }
                break;
        }
        args.returnValue = validationResult;
    };
    // << angular-dataform-property-validate-event
    SearchMainComponent.prototype.onPropertyValidated = function (args) {
        var dataForm = args.object, propertyName = args.propertyName;
        var arrivalDateProp = dataForm.getPropertyByName('arrivalDate');
        var departureDateProp = dataForm.getPropertyByName('departureDate');
        if (propertyName === 'arrivalDate' || propertyName === 'departureDate') {
            if (arrivalDateProp.isValid && departureDateProp.isValid
                && this.parseDate(departureDateProp.valueCandidate) && this.parseDate(arrivalDateProp.valueCandidate)) {
                var numberOfNights = moment(departureDateProp.valueCandidate, 'YYYY-MM-DD').diff(moment(arrivalDateProp.valueCandidate, 'YYYY-MM-DD'), 'd');
                if (platform_1.isAndroid) {
                    numberOfNights = moment(this.parseDate(departureDateProp.valueCandidate)).diff(this.parseDate(arrivalDateProp.valueCandidate), 'd');
                }
                this.form = tslib_1.__assign({}, this.form, { arrivalDate: this.parseDate(arrivalDateProp.valueCandidate), departureDate: this.parseDate(departureDateProp.valueCandidate), numberOfNights: numberOfNights });
                _.extend(dataForm.source, this.form);
            }
            else {
                if (arrivalDateProp.isValid && this.parseDate(arrivalDateProp.valueCandidate) && !(this.parseDate(departureDateProp.valueCandidate) && departureDateProp.isValid)) {
                    this.form = tslib_1.__assign({}, this.form, { arrivalDate: this.parseDate(arrivalDateProp.valueCandidate), departureDate: moment(this.parseDate(arrivalDateProp.valueCandidate), 'YYYY-MM-DD').add(+args.entityProperty.valueCandidate, 'd').format('YYYY-MM-DD'), numberOfNights: 1 });
                    _.extend(dataForm.source, this.form);
                }
            }
        }
        if (propertyName === 'numberOfNights') {
            var numberOfNights = +args.entityProperty.valueCandidate || 0;
            if (arrivalDateProp.isValid && (platform_1.isAndroid ? +arrivalDateProp.valueCandidate : +moment(arrivalDateProp.valueCandidate, 'YYYY-MM-DD'))) {
                this.form = tslib_1.__assign({}, this.form, { numberOfNights: numberOfNights, arrivalDate: this.parseDate(arrivalDateProp.valueCandidate), departureDate: moment(this.parseDate(arrivalDateProp.valueCandidate), 'YYYY-MM-DD').add(+args.entityProperty.valueCandidate, 'd').format('YYYY-MM-DD') });
                _.extend(dataForm.source, this.form);
            }
        }
    };
    SearchMainComponent.prototype.parseDate = function (dateStringOrNumber) {
        if (platform_1.isAndroid) {
            return (moment(+dateStringOrNumber) || moment(dateStringOrNumber)).format('YYYY-MM-DD');
        }
        else {
            return +dateStringOrNumber ? (moment(+dateStringOrNumber) || moment(dateStringOrNumber)).format('YYYY-MM-DD') : dateStringOrNumber;
        }
        // This is either number in string or date formatted in string
    };
    SearchMainComponent.prototype.onEditorUpdate = function (args) {
        if (args.propertyName == 'numberOfNights' || args.propertyName == 'numberOfPAX') {
            this.changeEditorSpacing(args.editor);
        }
        if (args.propertyName == 'arrivalDate' || args.propertyName == 'departureDate') {
            this.changeDateFormatting(args.editor);
        }
    };
    SearchMainComponent.prototype.changeEditorSpacing = function (editor) {
        if (applicationModule.ios) {
            var labelDef = editor.gridLayout.definitionForView(editor.valueLabel);
            labelDef.contentOffset = {
                horizontal: -25,
                vertical: 0
            };
        }
        else {
            editor.getHeaderView().setPadding(12, 12, 12, 48);
        }
    };
    SearchMainComponent.prototype.changeDateFormatting = function (editor) {
        if (applicationModule.ios) {
            var dateFormatter = NSDateFormatter.alloc().init();
            dateFormatter.dateFormat = 'yyyy-MM-dd';
            editor.dateFormatter = dateFormatter;
        }
        else {
            var simpleDateFormat = new java.text.SimpleDateFormat('yyyy-MM-dd', java.util.Locale.US);
            editor.setDateFormat && editor.setDateFormat(simpleDateFormat);
        }
    };
    SearchMainComponent.prototype.requestPermission = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.barcodeScanner.available().then(function (available) {
                if (available) {
                    _this.barcodeScanner.hasCameraPermission().then(function (granted) {
                        if (!granted) {
                            _this.barcodeScanner.requestCameraPermission().then(function () {
                                resolve('Camera permission granted');
                            });
                        }
                        else {
                            resolve('Camera permission was already granted');
                        }
                    });
                }
                else {
                    reject('This device does not have an available camera');
                }
            });
        });
    };
    SearchMainComponent.prototype.scanBarcode = function () {
        var _this = this;
        this.requestPermission().then(function (result) {
            _this.barcodeScanner.scan({
                cancelLabel: 'Cancel',
                message: 'Scan Booking QR Code',
                preferFrontCamera: false,
                showFlipCameraButton: false
            }).then(function (result) {
                _this.router.navigate(['booking-detail', result.text]);
            }, function (error) {
            });
        }, function (error) {
            console.log('ERROR', error);
        });
    };
    tslib_1.__decorate([
        core_1.ViewChild(angular_1.RadDataFormComponent),
        tslib_1.__metadata("design:type", angular_1.RadDataFormComponent)
    ], SearchMainComponent.prototype, "radDataForm", void 0);
    SearchMainComponent = tslib_1.__decorate([
        core_1.Component({
            selector: 'search-main-component',
            moduleId: module.id,
            templateUrl: './search-main.component.html',
        }),
        tslib_1.__metadata("design:paramtypes", [router_1.Router,
            page_1.Page,
            nativescript_barcodescanner_1.BarcodeScanner])
    ], SearchMainComponent);
    return SearchMainComponent;
}());
exports.SearchMainComponent = SearchMainComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLW1haW4uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VhcmNoLW1haW4uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQUE0RTtBQUM1RSwwQ0FBeUM7QUFDekMsZ0VBQWtFO0FBR2xFLCtCQUFpQztBQUNqQywwQkFBNEI7QUFDNUIsMENBQTRDO0FBQzVDLDREQUF3RTtBQUN4RSxxQ0FBNEM7QUFDNUMsMkVBQTZEO0FBQzdELGdDQUErQjtBQVUvQjtJQVdJLDZCQUFvQixNQUFjLEVBQ2QsSUFBVSxFQUNWLGNBQThCO1FBRjlCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxTQUFJLEdBQUosSUFBSSxDQUFNO1FBQ1YsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBVGxELFNBQUksR0FBZ0c7WUFDaEcsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDMUMsYUFBYSxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUN4RCxjQUFjLEVBQUUsQ0FBQztZQUNqQixXQUFXLEVBQUUsQ0FBQztTQUNqQixDQUFDO0lBS0YsQ0FBQztJQUVELHNDQUFRLEdBQVI7SUFDQSxDQUFDO0lBRUQsNkNBQWUsR0FBZjtJQUNBLENBQUM7SUFFRCwwQ0FBWSxHQUFaO1FBQ0ksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbEQsS0FBSyxDQUFDLFFBQVEsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2pELE1BQU0sQ0FBQztRQUNYLENBQUM7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQ3BDLFdBQVcsRUFBRSxJQUFJ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TC9CLGdCQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsdUJBQXVCO1lBQ2pDLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQixXQUFXLEVBQUUsOEJBQThCO1NBQzlDLENBQUM7aURBWThCLGVBQU07WUFDUixXQUFJO1lBQ00sNENBQWM7T0FiekMsbUJBQW1CLENBeUwvQjtJQUFELDBCQUFDO0NBQUEsQUF6TEQsSUF5TEM7QUF6TFksa0RBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFZpZXdDaGlsZCwgQWZ0ZXJWaWV3SW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCAqIGFzIGFwcGxpY2F0aW9uTW9kdWxlIGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb24nO1xuaW1wb3J0IHsgUHJvcGVydHlWYWxpZGF0b3IgfSBmcm9tICduYXRpdmVzY3JpcHQtdWktZGF0YWZvcm0nO1xuaW1wb3J0IHsgcmVnaXN0ZXJFbGVtZW50IH0gZnJvbSAnbmF0aXZlc2NyaXB0LWFuZ3VsYXInO1xuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudCc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBUb2FzdCBmcm9tICduYXRpdmVzY3JpcHQtdG9hc3QnO1xuaW1wb3J0IHsgUmFkRGF0YUZvcm1Db21wb25lbnQgfSBmcm9tICduYXRpdmVzY3JpcHQtdWktZGF0YWZvcm0vYW5ndWxhcic7XG5pbXBvcnQgeyBpc0FuZHJvaWQsIGlzSU9TIH0gZnJvbSAncGxhdGZvcm0nO1xuaW1wb3J0IHsgQmFyY29kZVNjYW5uZXIgfSBmcm9tICduYXRpdmVzY3JpcHQtYmFyY29kZXNjYW5uZXInO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gJ3VpL3BhZ2UnO1xuXG5kZWNsYXJlIHZhciBqYXZhOiBhbnk7XG5kZWNsYXJlIHZhciBOU0RhdGVGb3JtYXR0ZXI6IGFueTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdzZWFyY2gtbWFpbi1jb21wb25lbnQnLFxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3NlYXJjaC1tYWluLmNvbXBvbmVudC5odG1sJyxcbn0pXG5leHBvcnQgY2xhc3MgU2VhcmNoTWFpbkNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG5cbiAgICBAVmlld0NoaWxkKFJhZERhdGFGb3JtQ29tcG9uZW50KVxuICAgIHB1YmxpYyByYWREYXRhRm9ybTogUmFkRGF0YUZvcm1Db21wb25lbnQ7XG4gICAgZm9ybTogeyBhcnJpdmFsRGF0ZTogc3RyaW5nLCBkZXBhcnR1cmVEYXRlOiBzdHJpbmcsIG51bWJlck9mTmlnaHRzOiBudW1iZXIsIG51bWJlck9mUEFYOiBudW1iZXIgfSA9IHtcbiAgICAgICAgYXJyaXZhbERhdGU6IG1vbWVudCgpLmZvcm1hdCgnWVlZWS1NTS1ERCcpLFxuICAgICAgICBkZXBhcnR1cmVEYXRlOiBtb21lbnQoKS5hZGQoMSwgJ2QnKS5mb3JtYXQoJ1lZWVktTU0tREQnKSxcbiAgICAgICAgbnVtYmVyT2ZOaWdodHM6IDEsXG4gICAgICAgIG51bWJlck9mUEFYOiAxLFxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcGFnZTogUGFnZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGJhcmNvZGVTY2FubmVyOiBCYXJjb2RlU2Nhbm5lcikge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIH1cblxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB9XG5cbiAgICBnb1NlYXJjaFRyaXAoKSB7XG4gICAgICAgIGlmICh0aGlzLnJhZERhdGFGb3JtLmRhdGFGb3JtLmhhc1ZhbGlkYXRpb25FcnJvcnMoKSkge1xuICAgICAgICAgICAgVG9hc3QubWFrZVRleHQoJ1BsZWFzZSBmaXggZXJyb3IgZmllbGRzJykuc2hvdygpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnc2VhcmNoLXJlc3VsdCddLCB7XG4gICAgICAgICAgICBxdWVyeVBhcmFtczogdGhpcy5mb3JtXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgcHVibGljIG9uUHJvcGVydHlWYWxpZGF0ZShhcmdzKSB7XG4gICAgICAgIGxldCB2YWxpZGF0aW9uUmVzdWx0ID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgZGF0YUZvcm0gPSBhcmdzLm9iamVjdDtcbiAgICAgICAgbGV0IG90aGVyRGF0ZSwgY3VycmVudERhdGU7XG4gICAgICAgIHN3aXRjaCAoYXJncy5wcm9wZXJ0eU5hbWUpIHtcbiAgICAgICAgICAgIGNhc2UgJ2Fycml2YWxEYXRlJzpcbiAgICAgICAgICAgICAgICBvdGhlckRhdGUgPSBkYXRhRm9ybS5nZXRQcm9wZXJ0eUJ5TmFtZSgnZGVwYXJ0dXJlRGF0ZScpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnREYXRlID0gYXJncy5lbnRpdHlQcm9wZXJ0eTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJzZURhdGUob3RoZXJEYXRlLnZhbHVlQ2FuZGlkYXRlKSAmJiB0aGlzLnBhcnNlRGF0ZShvdGhlckRhdGUudmFsdWVDYW5kaWRhdGUpIDwgdGhpcy5wYXJzZURhdGUoY3VycmVudERhdGUudmFsdWVDYW5kaWRhdGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnREYXRlLmVycm9yTWVzc2FnZSA9ICdBcnJpdmFsIGRhdGUgc2hvdWxkIGxlc3MgdGhhbiBkZXBhcnR1cmUgZGF0ZSc7XG4gICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25SZXN1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YUZvcm0ubm90aWZ5VmFsaWRhdGVkKCdhcnJpdmFsRGF0ZScsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkYXRhRm9ybS5ub3RpZnlWYWxpZGF0ZWQoJ2RlcGFydHVyZURhdGUnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdkZXBhcnR1cmVEYXRlJzpcbiAgICAgICAgICAgICAgICBvdGhlckRhdGUgPSBkYXRhRm9ybS5nZXRQcm9wZXJ0eUJ5TmFtZSgnYXJyaXZhbERhdGUnKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50RGF0ZSA9IGFyZ3MuZW50aXR5UHJvcGVydHk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyc2VEYXRlKG90aGVyRGF0ZS52YWx1ZUNhbmRpZGF0ZSkgPiB0aGlzLnBhcnNlRGF0ZShjdXJyZW50RGF0ZS52YWx1ZUNhbmRpZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudERhdGUuZXJyb3JNZXNzYWdlID0gJ0RlcGFydHVyZSBkYXRlIHNob3VsZCBncmVhdGVyIHRoYW4gYXJyaXZhbCBkYXRlJztcbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG90aGVyRGF0ZS5lcnJvck1lc3NhZ2UgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgZGF0YUZvcm0ubm90aWZ5VmFsaWRhdGVkKCdhcnJpdmFsRGF0ZScsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBhcmdzLnJldHVyblZhbHVlID0gdmFsaWRhdGlvblJlc3VsdDtcbiAgICB9XG5cbi8vIDw8IGFuZ3VsYXItZGF0YWZvcm0tcHJvcGVydHktdmFsaWRhdGUtZXZlbnRcbiAgICBwdWJsaWMgb25Qcm9wZXJ0eVZhbGlkYXRlZChhcmdzKSB7XG4gICAgICAgIGxldCB7IG9iamVjdDogZGF0YUZvcm0sIHByb3BlcnR5TmFtZSB9ID0gYXJncztcbiAgICAgICAgbGV0IGFycml2YWxEYXRlUHJvcCA9IGRhdGFGb3JtLmdldFByb3BlcnR5QnlOYW1lKCdhcnJpdmFsRGF0ZScpO1xuICAgICAgICBsZXQgZGVwYXJ0dXJlRGF0ZVByb3AgPSBkYXRhRm9ybS5nZXRQcm9wZXJ0eUJ5TmFtZSgnZGVwYXJ0dXJlRGF0ZScpO1xuICAgICAgICBpZiAocHJvcGVydHlOYW1lID09PSAnYXJyaXZhbERhdGUnIHx8IHByb3BlcnR5TmFtZSA9PT0gJ2RlcGFydHVyZURhdGUnKSB7XG4gICAgICAgICAgICBpZiAoYXJyaXZhbERhdGVQcm9wLmlzVmFsaWQgJiYgZGVwYXJ0dXJlRGF0ZVByb3AuaXNWYWxpZFxuICAgICAgICAgICAgICAgICYmIHRoaXMucGFyc2VEYXRlKGRlcGFydHVyZURhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKSAmJiB0aGlzLnBhcnNlRGF0ZShhcnJpdmFsRGF0ZVByb3AudmFsdWVDYW5kaWRhdGUpKSB7XG4gICAgICAgICAgICAgICAgbGV0IG51bWJlck9mTmlnaHRzID0gbW9tZW50KGRlcGFydHVyZURhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlLCAnWVlZWS1NTS1ERCcpLmRpZmYobW9tZW50KGFycml2YWxEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSwgJ1lZWVktTU0tREQnKSwgJ2QnKTtcbiAgICAgICAgICAgICAgICBpZiAoaXNBbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlck9mTmlnaHRzID0gbW9tZW50KHRoaXMucGFyc2VEYXRlKGRlcGFydHVyZURhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKSkuZGlmZih0aGlzLnBhcnNlRGF0ZShhcnJpdmFsRGF0ZVByb3AudmFsdWVDYW5kaWRhdGUpLCAnZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmZvcm0gPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuZm9ybSxcbiAgICAgICAgICAgICAgICAgICAgYXJyaXZhbERhdGU6IHRoaXMucGFyc2VEYXRlKGFycml2YWxEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSksXG4gICAgICAgICAgICAgICAgICAgIGRlcGFydHVyZURhdGU6IHRoaXMucGFyc2VEYXRlKGRlcGFydHVyZURhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKSxcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZOaWdodHNcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIF8uZXh0ZW5kKGRhdGFGb3JtLnNvdXJjZSwgdGhpcy5mb3JtKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGFycml2YWxEYXRlUHJvcC5pc1ZhbGlkICYmIHRoaXMucGFyc2VEYXRlKGFycml2YWxEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSkgJiYgISh0aGlzLnBhcnNlRGF0ZShkZXBhcnR1cmVEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSkgJiYgZGVwYXJ0dXJlRGF0ZVByb3AuaXNWYWxpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5mb3JtLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyaXZhbERhdGU6IHRoaXMucGFyc2VEYXRlKGFycml2YWxEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXBhcnR1cmVEYXRlOiBtb21lbnQodGhpcy5wYXJzZURhdGUoYXJyaXZhbERhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKSwgJ1lZWVktTU0tREQnKS5hZGQoK2FyZ3MuZW50aXR5UHJvcGVydHkudmFsdWVDYW5kaWRhdGUsICdkJykuZm9ybWF0KCdZWVlZLU1NLUREJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBudW1iZXJPZk5pZ2h0czogMVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZChkYXRhRm9ybS5zb3VyY2UsIHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwcm9wZXJ0eU5hbWUgPT09ICdudW1iZXJPZk5pZ2h0cycpIHtcbiAgICAgICAgICAgIGxldCBudW1iZXJPZk5pZ2h0cyA9ICthcmdzLmVudGl0eVByb3BlcnR5LnZhbHVlQ2FuZGlkYXRlIHx8IDA7XG4gICAgICAgICAgICBpZiAoYXJyaXZhbERhdGVQcm9wLmlzVmFsaWQgJiYgKGlzQW5kcm9pZCA/ICthcnJpdmFsRGF0ZVByb3AudmFsdWVDYW5kaWRhdGUgOiArbW9tZW50KGFycml2YWxEYXRlUHJvcC52YWx1ZUNhbmRpZGF0ZSwgJ1lZWVktTU0tREQnKSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm0gPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuZm9ybSxcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZOaWdodHMsXG4gICAgICAgICAgICAgICAgICAgIGFycml2YWxEYXRlOiB0aGlzLnBhcnNlRGF0ZShhcnJpdmFsRGF0ZVByb3AudmFsdWVDYW5kaWRhdGUpLFxuICAgICAgICAgICAgICAgICAgICBkZXBhcnR1cmVEYXRlOiBtb21lbnQodGhpcy5wYXJzZURhdGUoYXJyaXZhbERhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKSwgJ1lZWVktTU0tREQnKS5hZGQoK2FyZ3MuZW50aXR5UHJvcGVydHkudmFsdWVDYW5kaWRhdGUsICdkJykuZm9ybWF0KCdZWVlZLU1NLUREJyksXG4gICAgICAgICAgICAgICAgICAgIC8vIGRlcGFydHVyZURhdGU6IG1vbWVudCgrYXJyaXZhbERhdGVQcm9wLnZhbHVlQ2FuZGlkYXRlKS5hZGQobnVtYmVyT2ZOaWdodHMsICdkJykuZm9ybWF0KCdZWVlZLU1NLUREJyksXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBfLmV4dGVuZChkYXRhRm9ybS5zb3VyY2UsIHRoaXMuZm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcGFyc2VEYXRlKGRhdGVTdHJpbmdPck51bWJlcikge1xuICAgICAgICBpZiAoaXNBbmRyb2lkKSB7XG4gICAgICAgICAgICByZXR1cm4gKG1vbWVudCgrZGF0ZVN0cmluZ09yTnVtYmVyKSB8fCBtb21lbnQoZGF0ZVN0cmluZ09yTnVtYmVyKSkuZm9ybWF0KCdZWVlZLU1NLUREJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gK2RhdGVTdHJpbmdPck51bWJlciA/IChtb21lbnQoK2RhdGVTdHJpbmdPck51bWJlcikgfHwgbW9tZW50KGRhdGVTdHJpbmdPck51bWJlcikpLmZvcm1hdCgnWVlZWS1NTS1ERCcpIDogZGF0ZVN0cmluZ09yTnVtYmVyO1xuICAgICAgICB9XG4gICAgICAgIC8vIFRoaXMgaXMgZWl0aGVyIG51bWJlciBpbiBzdHJpbmcgb3IgZGF0ZSBmb3JtYXR0ZWQgaW4gc3RyaW5nXG4gICAgfVxuXG4gICAgcHVibGljIG9uRWRpdG9yVXBkYXRlKGFyZ3MpIHtcbiAgICAgICAgaWYgKGFyZ3MucHJvcGVydHlOYW1lID09ICdudW1iZXJPZk5pZ2h0cycgfHwgYXJncy5wcm9wZXJ0eU5hbWUgPT0gJ251bWJlck9mUEFYJykge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VFZGl0b3JTcGFjaW5nKGFyZ3MuZWRpdG9yKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJncy5wcm9wZXJ0eU5hbWUgPT0gJ2Fycml2YWxEYXRlJyB8fCBhcmdzLnByb3BlcnR5TmFtZSA9PSAnZGVwYXJ0dXJlRGF0ZScpIHtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlRGF0ZUZvcm1hdHRpbmcoYXJncy5lZGl0b3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjaGFuZ2VFZGl0b3JTcGFjaW5nKGVkaXRvcikge1xuICAgICAgICBpZiAoYXBwbGljYXRpb25Nb2R1bGUuaW9zKSB7XG4gICAgICAgICAgICB2YXIgbGFiZWxEZWYgPSBlZGl0b3IuZ3JpZExheW91dC5kZWZpbml0aW9uRm9yVmlldyhlZGl0b3IudmFsdWVMYWJlbCk7XG4gICAgICAgICAgICBsYWJlbERlZi5jb250ZW50T2Zmc2V0ID0ge1xuICAgICAgICAgICAgICAgIGhvcml6b250YWw6IC0yNSxcbiAgICAgICAgICAgICAgICB2ZXJ0aWNhbDogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVkaXRvci5nZXRIZWFkZXJWaWV3KCkuc2V0UGFkZGluZygxMiwgMTIsIDEyLCA0OCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNoYW5nZURhdGVGb3JtYXR0aW5nKGVkaXRvcikge1xuICAgICAgICBpZiAoYXBwbGljYXRpb25Nb2R1bGUuaW9zKSB7XG4gICAgICAgICAgICB2YXIgZGF0ZUZvcm1hdHRlciA9IE5TRGF0ZUZvcm1hdHRlci5hbGxvYygpLmluaXQoKTtcbiAgICAgICAgICAgIGRhdGVGb3JtYXR0ZXIuZGF0ZUZvcm1hdCA9ICd5eXl5LU1NLWRkJztcbiAgICAgICAgICAgIGVkaXRvci5kYXRlRm9ybWF0dGVyID0gZGF0ZUZvcm1hdHRlcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBzaW1wbGVEYXRlRm9ybWF0ID0gbmV3IGphdmEudGV4dC5TaW1wbGVEYXRlRm9ybWF0KCd5eXl5LU1NLWRkJywgamF2YS51dGlsLkxvY2FsZS5VUyk7XG4gICAgICAgICAgICBlZGl0b3Iuc2V0RGF0ZUZvcm1hdCAmJiBlZGl0b3Iuc2V0RGF0ZUZvcm1hdChzaW1wbGVEYXRlRm9ybWF0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZXF1ZXN0UGVybWlzc2lvbigpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYmFyY29kZVNjYW5uZXIuYXZhaWxhYmxlKCkudGhlbigoYXZhaWxhYmxlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGF2YWlsYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmJhcmNvZGVTY2FubmVyLmhhc0NhbWVyYVBlcm1pc3Npb24oKS50aGVuKChncmFudGVkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWdyYW50ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJhcmNvZGVTY2FubmVyLnJlcXVlc3RDYW1lcmFQZXJtaXNzaW9uKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoJ0NhbWVyYSBwZXJtaXNzaW9uIGdyYW50ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgnQ2FtZXJhIHBlcm1pc3Npb24gd2FzIGFscmVhZHkgZ3JhbnRlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoJ1RoaXMgZGV2aWNlIGRvZXMgbm90IGhhdmUgYW4gYXZhaWxhYmxlIGNhbWVyYScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2NhbkJhcmNvZGUoKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYmFyY29kZVNjYW5uZXIuc2Nhbih7XG4gICAgICAgICAgICAgICAgY2FuY2VsTGFiZWw6ICdDYW5jZWwnLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdTY2FuIEJvb2tpbmcgUVIgQ29kZScsXG4gICAgICAgICAgICAgICAgcHJlZmVyRnJvbnRDYW1lcmE6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHNob3dGbGlwQ2FtZXJhQnV0dG9uOiBmYWxzZVxuICAgICAgICAgICAgfSkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydib29raW5nLWRldGFpbCcsIHJlc3VsdC50ZXh0XSk7XG4gICAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFUlJPUicsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==